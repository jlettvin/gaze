<!DOCTYPE html>

<html>
	<head>
        <meta charset="UTF-8">

<style>
/*******************************************************************************/
/*******************************************************************************/
/*******************************************************************************/

body {
	font-family:
            Courier New, Courier,
            Lucida Sans Typewriter, Lucida Typewriter,
            monospace;
	font-size: 10px;
	font-variant: normal;
	font-weight: 200;
	line-height: 10px;
        background-color: #ffffcc;
} /* body */
table, th, td {
	vertical-align: middle;
	text-align: center;
	padding: 0px;
	border-spacing: 0px;
} /* table */
td       { color: white; }
textarea { resize: none; }
button   { border-spacing: 0px; padding: 0px; margin: 0px; }
h1 { font-size: 30px; }
h2 { font-size: 25px; }
h3 { font-size: 20px; }
/*.square { height: 45px; width: 45px; color: white; } */
.title { height: 30px; font-size: 30px; color:black; background-color: white; }
.subtitle { height: 20px; font-size: 16px; color:black; background-color: white; }
.copyright { height: 10px; font-size: 8px; color:black; background-color: white; }

/*******************************************************************************/
/*******************************************************************************/
/*******************************************************************************/
</style>

<script type="text/javascript" src="utility.js"></script>

<script type="text/javascript">
/////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////

//-------------------------------------------------------------------------------
function clickBuzz (frequency, length) {
//-------------------------------------------------------------------------------
    // use stored audio context, masterGain and nodeGain1 nodes
	var the = document.distributor;
    var audioContext = the.audioContext;
    var masterGain   = the.masterGain;
    var nodeGain1    = the.nodeGain1;

    var oscillatorNode = new OscillatorNode (audioContext, {type: 'square'});
    oscillatorNode.frequency.setValueAtTime (frequency, audioContext.currentTime);
    oscillatorNode.connect (nodeGain1);
    oscillatorNode.start   (audioContext.currentTime);
    oscillatorNode.stop    (audioContext.currentTime + length);
} // clickBuzz


//-------------------------------------------------------------------------------
function ePower (direction)
//-------------------------------------------------------------------------------
{
	var the = document.distributor;
    var strength = document.getElementById ("strength");
    if (the.running)
    {
        if (
            (direction == -1 && the.strong > 0) ||
            (direction == +1 && the.strong < 3) )
        {
            the.strong += direction;
        }
    }
    strength.innerHTML = ' ' + the.strong + ' ';
} // ePower


//-------------------------------------------------------------------------------
function eDelay (direction)
//-------------------------------------------------------------------------------
{
	var the = document.distributor;
    var interval = document.getElementById ("interval");
    if (the.running)
    {
        var N = the.interval.length - 1;
        if (
            (direction == -1 && the.delay > 0) ||
            (direction == +1 && the.delay < N) )
        {
            the.delay += direction;
            clearInterval (the.timer);
            the.timer = setInterval (
                loop, the.interval[the.delay]);
        }
    }
    interval.innerHTML = ' ' + the.interval[the.delay] + ' ';
} // eDelay


//-------------------------------------------------------------------------------
function eSofter (e)
//-------------------------------------------------------------------------------
{
    ePower (-1);
} // eSofter


//-------------------------------------------------------------------------------
function eHarder (e)
//-------------------------------------------------------------------------------
{
    ePower (+1);
} // eHarder


//-------------------------------------------------------------------------------
function eSlower (e)
//-------------------------------------------------------------------------------
{
    eDelay (-1);
} // eSlower


//-------------------------------------------------------------------------------
function eFaster (e)
//-------------------------------------------------------------------------------
{
    eDelay (+1);
} // eFaster


//-------------------------------------------------------------------------------
function eButton (e)
//-------------------------------------------------------------------------------
{
	var the = document.distributor;
    var id = e.target.id;
    var key = document.getElementById (id).innerHTML;
    var val = the.info[key];
    var tgt = document.getElementById ('info');
    tgt.value = val;
} // eButton


//-------------------------------------------------------------------------------
function eRun (e)
//-------------------------------------------------------------------------------
{
	var the = document.distributor;
    the.running = !the.running;
    if (the.running) {
        the.timer = setInterval (
            loop, the.interval[the.delay]);
    } else {
        clearInterval (the.timer);
        the.timer = null;
    }
    var button = document.getElementById ("pause");
    button.innerHTML = the.running ? "PAUSE" : "START";
} // eRun


//-------------------------------------------------------------------------------
function reColor (className,scheme)
//-------------------------------------------------------------------------------
{
	var the = document.distributor;
    var colorPair = the.colors[scheme];
    var elements = document.getElementsByClassName (className);
    for (element of elements)
    {
        element.style.backgroundColor = colorPair[0];
        element.style.color           = colorPair[1];
    }
} // reColor


//-------------------------------------------------------------------------------
function makeButtons (names)
//-------------------------------------------------------------------------------
{
    var text = '';
    var i = 0;
    for (name of names)
    {
        var id = 'button' + i++;
        text += '<button id="' + id +
			'" onmouseover="eButton(event)"' +
			'" onclick="eButton(event)"' + '>' +
			name + '</button>';
    }
    var element = document.getElementById ('buttons');
    element.innerHTML = text;
} // makeButtons


//-------------------------------------------------------------------------------
function loop ()
//-------------------------------------------------------------------------------
{
	var the = document.distributor;
    var date = new Date ();
    var odd = (date.getSeconds () & 1);
    var strength = 1 + the.strong * odd;
    var I = the.active * strength;

    //console.log (the.inverses);
    clickBuzz (
        I * 1000 /
        the.interval[the.delay], 0.04);
    for (classname of the.inverses)
    {
        reColor (classname, 0);
    }
    the.inverses = [];

    for (var i=0; i<I; ++i)
    {
        the.index =
			(the.index + 1) %
			the.fiber.length;
        var classname = 'i' + the.fiber[the.index];

        the.inverses.push (classname);
        reColor (classname, 1);
    }
    var state = document.getElementById ('state');
    if (the.strong == 0)
    {
        state.innerHTML = 'same';
    } else {
        state.innerHTML = odd ? 'HARD' : 'soft';
    }
} // loop


//-------------------------------------------------------------------------------
function info ()
//-------------------------------------------------------------------------------
{
	var the = document.distributor;
    var info = the.info= {};

	info['Basic'] = HERE(function () {/*
   When a muscle is cut across, all the individual muscle "fibers" are seen.
Each fiber contracts/releases quickly (a twitch).  Fibers don't stay contracted.
An idle muscle has "tonus" (persistent contraction from many twitches).
Twitching exhausts a fiber.  It must sit idle for a time before twitching again.
   Tonus is when twitches are distributed evenly over fibers in a pattern
that keeps the number of twitching fibers the same and
maximizes time between twitches for any single fiber.
   More twitches at the same time leads to stronger contraction.
The nerve that drives twitches assigns one neuron to each fiber.
The nervous system produces sequences of signals that do not exhaust fibers.
*/});

    info['Abstract'] = HERE(function () {/*
   A muscle fiber bundle model is shown in cross section (each fiber a square).
A muscle fiber is a twitch unit which generates a shortening force.
A muscle fiber runs end-to-end and is excited by a single motor neuron.
After twitching a fiber needs time to recover before the next twitch.
   This model shows that the time between fiber activations can be maximized
while activations are uniformly distributed within the bundle.
*/});

    info['Running'] = HERE(function () {/*
   START/PAUSE animates the model.  Buttons control the interval and strength 
Hovering over buttons above the info box causes text like this to be shown.
   When running, the model shows twitching/resting muscle fibers as red/brown.
Twitch patterns show a repeating weak/STRONG tonus for 1 second each.
   Squares are identified by sequence numbers and center-based coordinates.
Note the (0,0) coordinates at the center of the bundle.
   Muscles make sounds as fibers twitch, and the model is representative.
When running, the sound frequency is in proportion to twitch activity.
*/});

    info['Axon'] = HERE(function () {/*
   A motor neuron attaches at many points along a single twitch unit.
A twitch signal is sent to all neuromuscular junctions in a muscle fiber.
A twitch unit is activated end-to-end with a single signal.
The entire length of the twitch unit contracts at the same time.
Motor neuron axon terminal arbor shapes guarantee simultaneous activation.
*/});

    info['Dendrite'] = HERE(function () {/*
   The remote dendrite shape for a motor neuron feeding a muscle fiber
is shaped to sample passing gradients in a transient sweeping pattern.
Each motor neuron dendrite is shaped to detect gradients ignored by others.
   The dendrite hosts a fixed set of pre-randomized dendritic spines.
As the sweeping pattern passes across the dendritic spines
those which sample a boundary in the pattern twitch their muscle fibers.
*/});

    info['Coincidences'] = HERE(function () {/*
   The remote dendrite for each motor neuron expresses a pattern
which makes its gradient detectors unique within sampled patterns.
It most likely samples the pattern in multiple places and uses
coincidence of samples to trigger the pulse that activates a muscle fiber.
*/});

    info['Discussion'] = HERE(function () {/*
   As long as the pattern delivered is reliable,
twitch unit duty cycle timing requirements are satisfied.
This strategy guarantees maximum recovery time for all muscle fibers.
   The animated model below illustrates this behavior.
The code driving this image is logically equivalent to
the proposed pre-randomized sampling of a regular pattern.
   Twitch is "all or none": tonus measures average twitches per unit time.
*/});

    info['Conclusions'] = HERE(function () {/*
   This simple demonstration illustrates a logical economy
enabling implementations to ignore parallelism and simply
act concurrently on all actual delivered pulses,
whether they are dense or sparse,
without the burden of unnecessary calculation.
   This is one of the economies expected in vivo.
*/});

    var keys = [];
    for (key in info) keys.push (key);
    makeButtons (keys);

} // info


//-------------------------------------------------------------------------------
// stackoverflow.com/questions/1409225/changing-a-css-rule-set-from-javascript
function getCSSRule(ruleName) {
//-------------------------------------------------------------------------------
    ruleName = ruleName.toLowerCase();
    var result = null;
    var find = Array.prototype.find;

    find.call(document.styleSheets, styleSheet => {
		//var rules = styleSheet.cssRules || sheet.rules;
		//var rules = styleSheet.cssRules || sheet.rules;
        //result = find.call(rules, cssRule => {
        result = find.call(styleSheet.cssRules, cssRule => {
            return cssRule instanceof CSSStyleRule 
                && cssRule.selectorText.toLowerCase() == ruleName;
        });
        return result != null;
    });
    return result;
} // getCSSRule


function addCSSRule(sheet, selector, rules, index) {
	if("insertRule" in sheet) {
		sheet.insertRule(selector + "{" + rules + "}", index);
	}
	else if("addRule" in sheet) {
		sheet.addRule(selector, rules, index);
	}
}


//-------------------------------------------------------------------------------
function main ()
//-------------------------------------------------------------------------------
{
    var audioContext = new (window.AudioContext || window.webkitAudioContext)();

    document.distributor = {
		xylabel :   false,
        active  :   11,
        colors  :       [['#552222','white'], ['#bb3333','white']],
        delay   :    3,
        interval:       [3, 10, 33, 100, 333, 1000],
        index   :    0,
        inverses:   [],
        running : true,
        strong  :    2,
        timer   : null,
        audioContext: audioContext,
        masterGain  : audioContext.createGain(),
        nodeGain1   : audioContext.createGain(),
    };
	var the = document.distributor;
	the.radius = 6;  // Must be 5 or greater (diameter - 6 is used)

	the.diameter = 1 + 2 * the.radius;
	the.coordinates = [];
	the.fiber = [];

	var sheet = document.styleSheets[0];
	var px = the.xylabel ? 45 : 34;
	addCSSRule (sheet,
		".square", "height: " + px + "px; width: " + px + "px; color: white;");

	// Generate the table from the coordinates
	// Once this is done, distributor.py is no longer needed.
	// The table id = "bundle".
	// Generate the metadata here.

	var controlCols = 6;

	var table    = document.getElementById ("bundle");
	var tbody    = document.getElementById ("tbody");
	var animator = document.getElementById ("animator");

	tbody.innerHTML = '';

	animator.colSpan = the.diameter - controlCols;
	var X = 0, Y = 0, index = 0;

	for (y = -the.radius; y <= +the.radius; ++y) {
		// Generate the table rows here
		var row = tbody.insertRow (-1);
		var ysign = (y<0) ? '+' : '';
		for (x = -the.radius; x <= +the.radius; ++x) {
			// Generate the fiber data here
			// index is the order number for the current fiber
			// the.fiber is an enumeration of all visible fiber indices
			// the.fiber is shuffled and used to identify fibers by class
			var xsign = (x>=0) ? '+' : '';
			var within = false;
			var r = Math.sqrt (x*x + y*y);
			var fiber = row.insertCell (-1);
			fiber.classList.add ('square');
			fiber.innerHTML = '' + the.fiber.length
			if (the.xylabel) {
				fiber.innerHTML += '<br /><br />';
				fiber.innerHTML += '(' + xsign + x + ',' + ysign + -y + ')';
			}
			if (r < (the.radius + 0.3)) {
				within = true;
				the.fiber.push (index);
				the.coordinates.push ([y,-x,index]);
				// generate visible fiber
			} else {
				// generate invisible cell
			}
			var id = (within ? 'i' : 'x') + index++;
			fiber.classList.add (id);
			fiber.style.backgroundColor = within ? "#552222" : "white";
			fiber.style.color = "white";
		}
	}
	shuffle (the.fiber);

    var masterGain   = document.distributor.masterGain;
    var nodeGain1    = document.distributor.nodeGain1;

	masterGain.gain.setValueAtTime (0.5, audioContext.currentTime);
    masterGain.connect(audioContext.destination);

	nodeGain1.gain.setValueAtTime (0.5, audioContext.currentTime);
    nodeGain1.connect(masterGain);

    info ();
    eSlower ();
    eSofter ();
    eRun ();
} // main


//-------------------------------------------------------------------------------
window.onload = function ()
//-------------------------------------------------------------------------------
{
    main ();
} // window.onload

/////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////
</script>

	</head>
	<body>
        <div align="center">

<table width="100%">
	<tr><td class="title">
		<u>Twitch Distributor Visualization</u>
		</td></tr><tr><td class="subtitle">
		Twitch Distributor: An element of the
		<a href="http://www.brainbuildingkit.com">
			<i>Brain Building Kit&trade;</i>
		</a>
	</td></tr><tr><td class="copyright">
        <i>Copyright&copy; 2018 Jonathan D. Lettvin, All Rights Reserved.</i>
	</td></tr>
</table>

        <br /><span id="buttons"></span>
        <br /><textarea id="info" rows="10" cols="84" readonly>
        Hover over the above buttons to show information in this area.
        </textarea><br />

 <table id="bundle">
	<caption align="bottom">
		<h3>Muscle Fiber Bundle Cross Section</h3>
	</caption>
	<thead>
<tr>
	<td id="animator" colspan="7" bgcolor="black">
		<button id="pause" onclick="eRun(event)">STOP</button>
		action, or
		<button id="reload" onclick="location.reload (true)">reload</button>
	</td><td colspan="2" bgcolor="#333333" valign="top">
		delay(ms)<br /><br /><br />
		<button id="neg" onclick="eSlower (event)">-</button>
		<b id="interval"></b>
		<button id="pos" onclick="eFaster (event)">+</button>
	</td><td colspan="2" bgcolor="#333333" valign="top">
		harder<br /><br /><br />
		<button id="pown" onclick="eSofter (event)">-</button>
		<b id="strength">2</b>
		<button id="powp" onclick="eHarder (event)">+</button>
	</td><td colspan="2" bgcolor="#333333">tonus<h3 id="state">None</h3></td>
</tr>
	</thead>

	<tbody id="tbody"></tbody>
</table>

        </div>
	</body>
</html>

